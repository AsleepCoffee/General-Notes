**Alternate Data Streams:** https://blog.malwarebytes.com/101/2015/07/introduction-to-alternate-data-streams/

**Hooking natvie APIs / SSDT(System Service Descriptor Table):** Native API os API that resides in ntdll.dll and basically is used to communicate with kernel mode. Each entry in the SSDT table, there is a function in kernel mode which completes the tast specified by the API  (User mode native API <-> SSDT Table <-> Kernel mode)
Hooking here means to have the malicious function to be called instead of the real function. Nowadays most anti-virus/rootkit-detectors scan SSDT table for modifications then compare it to the copy stored in the kernel.

**Hooking IRP:** Windows arch in kernel mode intorduced the concept of IRPs (I/O Request Packets) to transmit data from one component to another. Almost everything in the windows kernel uses IRPs, like network interface, filesystem, keyboard and mouse, and almost all existent drivers.

2 Ways to play with IRPs:
 - Become a filter driver: Register with the OS as a filter driver or an attached device.
 - Hooking the function pointer: 

Basic IRP design is so that after an IRP has been created, it is passed to all devices registered at lower levels. 
The design has two mode: 
  - pre-processing mode: Done when IRP arrives 
  - post-processing mode: Dne when IRP has been processed by all the levels below current level. 

**Hiding a process:** 

Required a combo of different techniques. And after you have to hide the process from EPROCESS list. That list is maintianed by the OS for all active processes.

If the driver is loaded, you also need to unlink it from the PsLoadedModuleList. 

**API Hooking:**

API hooking is essentially the act of intercepting an API function call, modifying its function either by redirecting it to a function of our choosing, stopping the function from eing called, or loging the request, etc.

Different types such as: 

 - IAT(Import Address Table) Hooking: Used to resolve runtime dependencies (i.e when using messageboxA API the compiler will link it to user32.dll) That makes the program dependent on user32.dll. Hooking invloves moding the IAT table of the exe and replace the function with our own copy. Can be done on both EXE and DLL
 - EAT(Export Address Table) Hooking: Table is maintaned in DLLs. These files just contain support functions for other execuatble files. Can only be done on DLLs.
 - Inline Hooking: Most difficult. Modify the first few bytes of the target function code and replace them with our code which tells the Instructuon pointer to exe code womewhere else in memory.

**Anti-Debugging:** 

INT 2D: Set up an exception handler, Cause the exception with INT 2dh , if the debugger is attached and does not pass the exception

**Anti-VM:** 

Utilize bugs and other key indicators that the malware is running on a VM.

One trick is the SITD instruction, which returns the IDT address. On real machines it is in low memory less that 0xd0 which for VM it is higher than that, which is abnormal and malware may use that to determine if this is running on VM or not.

**Obfuscation:**

Transform/change a program in order to make it more difficult to analyze while preserving functionality. Use by both malware and legal software to protect itself.
Use by malware to help prevent detection or make rev more difficult.

Drawback: lack of theoretical basis about their efficiency 

Malware might obfuscate itself everytime it infects a new machine. AV engines are based on signatures which can fooled by this.

**Packers:** 

Compress the executable. Malware authors realized the decreasing the file size will decrese number of patterns in the file, so less chance of AV detection. 

Packer facts:  compress/encrypt apps, cannot see the code of the app using a disasembler, you have to unpack it fist, compress apps and add a small loader to the file, The loader will decompress the binary in memory, resolve imports, and call the Original Entry Point (OEP).

**Polymorphism:**

Aims at performing a given actions (or algorithm) through code that mutates and changes every time the action has to be taken. The mutation makes them very difficult to detect. All poly viruses have a constant encoding and variable decryptor. So a virus using a diff XOR key to encrypt its variant also falls into the poly category. 

**Metamorphism:** 
















